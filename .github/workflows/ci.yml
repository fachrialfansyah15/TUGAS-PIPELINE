name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.CI_DB_PASSWORD }}
          POSTGRES_DB: jalan_rusak
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate .env for CI
        run: |
          cat > .env <<'EOF'
          TZ=UTC
          PORT=3333
          HOST=localhost
          LOG_LEVEL=info
          APP_KEY=${{ secrets.CI_APP_KEY || 'ci_dummy_key_please_replace' }}
          NODE_ENV=test
          DB_HOST=127.0.0.1
          DB_PORT=5432
          DB_USER=postgres
          DB_PASSWORD=${{ secrets.CI_DB_PASSWORD }}
          DB_DATABASE=jalan_rusak
          EOF

      - name: Show NODE_ENV for debugging
        run: |
          echo "NODE_ENV from job env: $NODE_ENV"
          grep NODE_ENV .env || true

      - name: Wait for Postgres
        run: |
          for i in {1..20}; do
            nc -z 127.0.0.1 5432 && echo "Postgres is up" && break
            echo "Waiting for Postgres..." && sleep 2
          done

      - name: Migrate database (if migrations exist)
        run: |
          npx --yes ts-node-maintained -e "console.log('checking migrations dir...')" >/dev/null 2>&1 || true
          if [ -d database/migrations ] && [ "$(ls -A database/migrations | wc -l)" -gt 0 ]; then
            echo "Running migrations"; node ace migration:run
          else
            echo "No migrations found, skipping"
          fi

      - name: Seed database (optional)
        run: |
          node ace db:seed || echo "No seeds to run"

      - name: Lint (ESLint)
        run: npm run lint

      - name: Typecheck (TS)
        run: npm run typecheck

      - name: Run tests with coverage (c8)
        run: npx --yes c8 -r text -r lcov node ace test

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info

      - name: Smoke test server
        run: |
          # Start production server explicitly with HOST/PORT from env
          HOST=127.0.0.1 PORT=3333 nohup node bin/server.js > server.log 2>&1 & echo $! > server.pid
          # Wait up to ~60s for port to be ready, printing log snippet periodically
          for i in {1..60}; do
            nc -z 127.0.0.1 3333 && echo "Server is up" && break
            if [ $((i % 5)) -eq 0 ]; then echo "--- last 20 lines of server.log ---"; tail -n 20 server.log || true; fi
            echo "Waiting server..." && sleep 1
          done
          curl -f http://127.0.0.1:3333/api/laporan || (echo "Smoke test failed" && echo "==== server.log ====" && cat server.log && exit 1)
          kill $(cat server.pid) || true
